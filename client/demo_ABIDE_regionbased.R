#!/usr/bin/env Rscript
#
# Runs a general linear model (GLM) analysis of region-based brain morphometry data.
# The data have typically been generated by FreeSurfer.
#
# Written by Tim SchÃ¤fer, 202-01-22

library("brainnet");
library("fsbrain");   # loading neuroimaging data and visualizing results. you need a version > 0.5.0, to get that run: devtools::install_github("dfsp-spirit/fsbrain")
library("readxl");    # read Excel demographcis file
library("MatchIt");   # matching of patient/control groups
library("ggplot2");   # general purpose plots
library("slmtools");  # internal R package of Ecker neuroimaging group for mass-univariate GLM analysis.

################################################################################
########################## Load data and demographics ##########################
################################################################################

do_plot=FALSE;

if(brainnet:::get_os() == "linux") {
    study_dir = "~/nas/projects/abide";
    if(! dir.exists(study_dir)) {
        study_dir = sprintf("/media/%s/science/data/abide", Sys.getenv("LOGNAME"));
    }
} else {
    study_dir = "/Volumes/shared/projects/abide";
}

if(dir.exists("~/data/abide_min")) {
    study_dir = "~/data/abide_min"; # use local minimal data dir if available, loading from a local SSD is much faster than loading via LAN from the NAS.
}

subjects_dir = file.path(study_dir, "structural"); # the FreeSurfer SUBJECTS_DIR containing the neuroimaging data.
if(! dir.exists(subjects_dir)) {
    stop(sprintf("The subjects_dir '%s' does not exist.\n", subjects_dir));
}

md = load_ABIDE_metadata(impute_data = TRUE);
demographics = md$merged; # merged brainstats and demographics.
subjects_list = demographics$subject_id;

subjects_control = subjects_list[demographics$group == "control"];
subjects_asd = subjects_list[demographics$group == "asd"];

cat(sprintf("Working with %d subjects in total: %d ASD and %s controls.\n", length(subjects_list), length(subjects_asd), length(subjects_control)));
if(length(subjects_asd) + length(subjects_control) != length(subjects_list)) {
    stop("Invalid group assignment to case/control (or more than 2 groups).");
}

measure="thickness";
hemi="split";
atlas="aparc";
agg_control = fsbrain::group.agg.atlas.native(subjects_dir, subjects_control, measure=measure, hemi=hemi, atlas=atlas);#, cache_file = sprintf("cache_ABIDE_control_%s_%s_%s.Rdata", measure, hemi, atlas));
agg_asd = fsbrain::group.agg.atlas.native(subjects_dir, subjects_asd, measure=measure, hemi=hemi, atlas=atlas); #, cache_file = sprintf("cache_ABIDE_asd_%s_%s_%s.Rdata", measure, hemi, atlas));

# fsbrain::vis.subject.morph.native(subjects_dir, "UM_1_0050272", measure = "thickness");
#fsbrain:::qc.for.group(subjects_dir, subjects_list, measure = "thickness", atlas = "aparc");


